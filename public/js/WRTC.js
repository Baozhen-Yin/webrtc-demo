!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).WRTC=t()}(this,(function(){"use strict";function e(e){console.log(e)}function t(e){console.warn(e)}function i(e,t=(()=>{})){console.error(e),t()}function n(e,t){var i=(new Date).getTime();return function(){var n=(new Date).getTime();n-i>=t&&(i=n,e.apply(null,arguments))}}class o{constructor(e){const{dataChanel:t,whiteboardId:i}=e;this.dataChanel=t,this.drawing=!1,this.whiteboard=document.getElementById(i),this.whiteboardContext=this.whiteboard.getContext("2d"),this.current={color:"red"}}onMouseDown=e=>{console.log("mouseDown"),this.drawing=!0,this.current.x=e.clientX||e.touches[0].clientX,this.current.y=e.clientY||e.touches[0].clientY};onMouseUp=e=>{this.drawing&&(this.drawing=!1,this.drawLine(this.current.x,this.current.y,e.clientX||e.touches[0].clientX,e.clientY||e.touches[0].clientY,this.current.color,!0))};onMouseMove=e=>{console.log("mouseMove"),this.drawing&&(this.drawLine(this.current.x,this.current.y,e.clientX||e.touches[0].clientX,e.clientY||e.touches[0].clientY,this.current.color,!0),this.current.x=e.clientX||e.touches[0].clientX,this.current.y=e.clientY||e.touches[0].clientY)};drawLine=(e,t,i,n,o,a)=>{if(console.log({x0:e,y0:t,x1:i,y1:n,color:o,emit:a}),this.whiteboardContext.beginPath(),this.whiteboardContext.moveTo(e-this.whiteboard.offsetLeft,t-this.whiteboard.offsetTop),this.whiteboardContext.lineTo(i-this.whiteboard.offsetLeft,n-this.whiteboard.offsetTop),this.whiteboardContext.strokeStyle=o,this.whiteboardContext.lineWidth=2,this.whiteboardContext.stroke(),this.whiteboardContext.closePath(),a){var s=this.whiteboard.width,r=this.whiteboard.height;this.dataChanel&&this.dataChanel.send(JSON.stringify({type:"whiteboard",data:{x0:e/s,y0:t/r,x1:i/s,y1:n/r,color:o}}))}};toggleWhiteboard=()=>{var e,t;"none"===this.whiteboard.style.display?((e=this.whiteboard).style.opacity=0,e.style.display=t||"block",function t(){var i=parseFloat(e.style.opacity);(i+=.1)>1||(e.style.opacity=i,requestAnimationFrame(t))}(),this.whiteboard.addEventListener("mousedown",this.onMouseDown,!1),this.whiteboard.addEventListener("mouseup",this.onMouseUp,!1),this.whiteboard.addEventListener("mouseout",this.onMouseUp,!1),this.whiteboard.addEventListener("mousemove",n(this.onMouseMove,10),!1),this.whiteboard.addEventListener("touchstart",this.onMouseDown,!1),this.whiteboard.addEventListener("touchend",this.onMouseUp,!1),this.whiteboard.addEventListener("touchcancel",this.onMouseUp,!1),this.whiteboard.addEventListener("touchmove",n(this.onMouseMove,10),!1)):(this.whiteboard.removeEventListener("mousedown",this.onMouseDown,!1),this.whiteboard.removeEventListener("mouseup",this.onMouseUp,!1),this.whiteboard.removeEventListener("mouseout",this.onMouseUp,!1),this.whiteboard.removeEventListener("mousemove",n(this.onMouseMove,10),!1),this.whiteboard.removeEventListener("touchstart",this.onMouseDown,!1),this.whiteboard.removeEventListener("touchend",this.onMouseUp,!1),this.whiteboard.removeEventListener("touchcancel",this.onMouseUp,!1),this.whiteboard.removeEventListener("touchmove",n(this.onMouseMove,10),!1),fadeOut(this.whiteboard))}}class a{constructor(t){this.RTCPeerConnection=null,this.DataChanel=null,this.WHITEBOARD=null,this.webcamStream=null,this.videoEnabled=!0,this.audioEnabled=!0,this.mode="camera";const{localVideoId:i="localVideo",remoteVideoId:n="remoteVideo",whiteboardId:o="whiteboard",iceServers:a=[],socket:s,room:r=location.href,mediaConstraint:h={video:!0,audio:!0}}=t;this.localVideo=document.getElementById(i),this.remoteVideo=document.getElementById(n),this.iceServers=a,this.socket=s,this.room=r,this.mediaConstraint=h,this.whiteboardId=o,s.on("ready",this.invite),s.on("offer",this.onOffer),s.on("answer",this.onAnswer),s.on("icecandidate",this.onIceCandidata),this.getUserMedia().then((()=>{e(`加入房间${this.room}`),this.socket.emit("join",this.room)}))}createPeerConnection=()=>{e("创建rtcpeerconnection"),this.RTCPeerConnection=new RTCPeerConnection({iceServers:this.iceServers}),this.RTCPeerConnection.onconnectionstatechange=this.handleConnectionStateChange,this.RTCPeerConnection.onicecandidateerror=i,this.RTCPeerConnection.onicecandidate=this.handleICECandidateEvent,this.RTCPeerConnection.oniceconnectionstatechange=this.handleICEConnectionStateChange,this.RTCPeerConnection.onicegatheringstatechange=this.handleICEGatheringStateChange,this.RTCPeerConnection.onsignalingstatechange=this.handleSignalingStateChange,this.RTCPeerConnection.onnegotiationneeded=this.handleNegotiationNeededEvent,this.RTCPeerConnection.ontrack=this.handleTrackEvent,this.DataChanel=this.RTCPeerConnection.createDataChannel("chat",{negotiated:!0,id:0}),this.DataChanel.onopen=t=>{e("dataChannel opened")},this.DataChanel.onmessage=t=>{const i=JSON.parse(t.data);e({receivedData:i});const n=i.type,o=i.data;"whiteboard"===n?this.handleRecieveWhiteboard(o):this.onRecieveMessage(o)},this.WHITEBOARD=new o({dataChanel:this.DataChanel,whiteboardId:this.whiteboardId})};invite=()=>{e("发起呼叫"),this.createPeerConnection();try{this.webcamStream.getTracks().forEach((e=>this.RTCPeerConnection.addTrack(e,this.webcamStream)))}catch(e){i(e)}};getUserMedia=async()=>{e("获取媒体流");try{return this.webcamStream=await navigator.mediaDevices.getUserMedia(this.mediaConstraint),this.localVideo.srcObject=this.webcamStream,this.webcamStream}catch(e){i(e)}};getDisplayMedia=async()=>{e("获取桌面流");try{return this.webcamStream=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!1}),this.localVideo.srcObject=this.webcamStream,this.webcamStream}catch(e){i(e)}};handleNegotiationNeededEvent=async()=>{e("开始协商");try{if("stable"!=this.RTCPeerConnection.signalingState)return void e("signalingState ！= stable，推迟协商");e("setLocalDescription（设置本地描述）"),await this.RTCPeerConnection.setLocalDescription(),e("发送offer给对等端"),this.socket.emit("offer",this.RTCPeerConnection.localDescription,this.room)}catch(e){i(e)}};handleConnectionStateChange=()=>{switch(t("连接状态变更为: "+this.RTCPeerConnection.connectionState),this.RTCPeerConnection.connectionState){case"connected":const i=this.RTCPeerConnection.getConfiguration();e("*** 连接配置为: "+JSON.stringify(i));break;case"disconnected":break;case"failed":t("连接失败，现在开始重新协商"),this.RTCPeerConnection.restartIce(),setTimeout((()=>{"connected"!==this.RTCPeerConnection.iceConnectionState&&(e("重新协商失败，新建rtcpeerconnection,重新呼叫"),this.invite())}),1e4)}};handleTrackEvent=t=>{e("Track event: "),this.remoteVideo.srcObject=t.streams[0],this.onTrack(t)};handleICECandidateEvent=t=>{t.candidate&&(e("发送 ICE candidate: "+t.candidate.candidate),this.socket.emit("icecandidate",t.candidate,this.room))};handleICEConnectionStateChange=t=>{e("ICE连接状态变更为 "+this.RTCPeerConnection.iceConnectionState)};handleSignalingStateChange=t=>{if(e("信令状态变更为: "+this.RTCPeerConnection.signalingState),"closed"===this.RTCPeerConnection.signalingState)this.invite()};handleICEGatheringStateChange=t=>{e("ICE收集状态变更为 : "+this.RTCPeerConnection.iceGatheringState)};onOffer=async t=>{if(e("收到offer"),this.invite(),"stable"!=this.RTCPeerConnection.signalingState)return e("  - But the signaling state isn't stable, so triggering rollback"),void await Promise.all([this.RTCPeerConnection.setLocalDescription({type:"rollback"}),this.RTCPeerConnection.setRemoteDescription(t)]);e("Setting remote description(设置远端描述)"),await this.RTCPeerConnection.setRemoteDescription(t),e("创建并发送answer给对等端"),await this.RTCPeerConnection.setLocalDescription(),this.socket.emit("answer",this.RTCPeerConnection.localDescription,this.room)};onAnswer=async t=>{e("收到answer"),await this.RTCPeerConnection.setRemoteDescription(t).catch(i)};onIceCandidata=async t=>{e("从对等端收到icecandidate: ");try{await this.RTCPeerConnection.addIceCandidate(t)}catch(e){i(e)}};sendData=e=>{console.log("data: ",e),this.DataChanel.send(JSON.stringify(e))};muteMicrophone=()=>{this.webcamStream.getTracks().forEach((e=>{"audio"===e.kind&&(e.enabled=!e.enabled,this.audioEnabled=e.enabled,this.onMuteMicrophone(e.enabled))}))};pauseVideo=()=>{this.webcamStream.getTracks().forEach((e=>{"video"===e.kind&&(e.enabled=!e.enabled,this.videoEnabled=e.enabled,this.onPauseVideo(e.enabled))}))};togglePictureInPicture=()=>{"pictureInPictureEnabled"in document||this.remoteVideo.webkitSetPresentationMode?document.pictureInPictureElement?document.exitPictureInPicture().catch((t=>{e(t)})):"inline"===this.remoteVideo.webkitPresentationMode?this.remoteVideo.webkitSetPresentationMode("picture-in-picture"):"picture-in-picture"===this.remoteVideo.webkitPresentationMode?this.remoteVideo.webkitSetPresentationMode("inline"):this.remoteVideo.requestPictureInPicture().catch((e=>{alert("您必须连接到其他人才能进入画中画模式")})):alert("你的浏览器不支持画中画。考虑使用Chrome或Safari。"),this.onTogglePictureInPicture()};switchStream=e=>{const t=e.getVideoTracks()[0];this.RTCPeerConnection.getSenders().find((function(e){return e.track.kind===t.kind})).replaceTrack(t)};swap=async()=>{if("camera"===this.mode)try{this.webcamStream=await this.getDisplayMedia(),this.switchStream(this.webcamStream),this.mode="screen"}catch(t){e(t)}else try{this.webcamStream=await navigator.mediaDevices.getUserMedia(),this.switchStream(this.webcamStream),this.mode="camera"}catch(t){e(t)}};handleRecieveWhiteboard(e){"none"===this.WHITEBOARD.whiteboard.style.display&&this.WHITEBOARD.toggleWhiteboard();const t=this.WHITEBOARD.whiteboard.width,i=this.WHITEBOARD.whiteboard.height;this.WHITEBOARD.drawLine(e.x0*t,e.y0*i,e.x1*t,e.y1*i,e.color)}}return a.prototype.onMuteMicrophone=e=>{console.log({enabled:e})},a.prototype.onPauseVideo=e=>{console.log({enabled:e})},a.prototype.onTogglePictureInPicture=()=>{console.log("onTogglePictureInPicture")},a.prototype.onRecieveMessage=e=>{console.log("msg: ",e)},a.prototype.onTrack=e=>{console.log("event: ",e)},a}));
